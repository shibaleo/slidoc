---
import config from 'virtual:starlight/user-config';

import LanguageSelect from 'virtual:starlight/components/LanguageSelect';
import Search from 'virtual:starlight/components/Search';
import SiteTitle from 'virtual:starlight/components/SiteTitle';
import ThemeSelect from 'virtual:starlight/components/ThemeSelect';
import { getSlideUrl, shouldShowSlideLink } from '../utils/urls';

/**
 * Render the `Search` component if Pagefind is enabled or the default search component has been overridden.
 */
const shouldRenderSearch =
	config.pagefind || config.components.Search !== '@astrojs/starlight/components/Search.astro';

// Get current page slug for slide link
const pathname = Astro.url.pathname;
const slug = pathname.replace(/^\//, '').replace(/\/$/, '');
const slideUrl = getSlideUrl(slug);
const showSlideLink = shouldShowSlideLink(slug);
---

<div class="header">
	<div class="title-wrapper sl-flex">
		<SiteTitle />
	</div>
	<div class="sl-flex print:hidden search-group">
		{showSlideLink && (
			<div class="slide-link-wrapper">
				<a href={slideUrl} class="slide-link slide-link-mobile" title="スライドモードで開く">
					<span>Slide</span>
				</a>
			</div>
		)}
		{shouldRenderSearch && <Search />}
	</div>
	<div class="sl-hidden md:sl-flex print:hidden right-group">
		{showSlideLink && (
			<div class="slide-link-wrapper">
				<a href={slideUrl} class="slide-link slide-link-desktop" title="スライドモードで開く">
					<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
						<path d="M18 4v5H6V4h12m0-2H6c-1.1 0-2 .9-2 2v5c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 13v5H6v-5h12m0-2H6c-1.1 0-2 .9-2 2v5c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-5c0-1.1-.9-2-2-2z"/>
					</svg>
					<span>Slide</span>
				</a>
			</div>
		)}
		<ThemeSelect />
		<LanguageSelect />
	</div>
</div>

<!-- Slide hint modal (shown on first visit) -->
{showSlideLink && (
	<div class="slide-hint-overlay" id="slideHintOverlay">
		<div class="slide-hint-modal" id="slideHintModal">
			<div class="slide-hint-content">
				<div class="slide-hint-title">Slide Mode Available</div>
				<a href={slideUrl} class="slide-hint-action">
					View as Slide
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
						<path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
					</svg>
				</a>
				<button type="button" class="slide-hint-dismiss" id="slideHintDismiss">
					Don't show again
				</button>
			</div>
			<button class="slide-hint-close" aria-label="Close">
				<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
					<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
				</svg>
			</button>
		</div>
	</div>
)}

<style>
	@layer starlight.core {
		.header {
			display: flex;
			gap: var(--sl-nav-gap);
			justify-content: space-between;
			align-items: center;
			height: 100%;
		}

		.title-wrapper {
			/* Prevent long titles overflowing and covering the search and menu buttons on narrow viewports. */
			overflow: clip;
			/* Avoid clipping focus ring around link inside title wrapper. */
			padding: 0.25rem;
			margin: -0.25rem;
			min-width: 0;
		}

		.search-group {
			gap: 0.5rem;
			align-items: center;
		}

		.right-group {
			gap: 1rem;
			align-items: center;
		}

		.slide-link {
			display: flex;
			align-items: center;
			gap: 0.375rem;
			padding: 0.375rem 0.75rem;
			margin-right: 0.5rem;
			border-radius: 0.375rem;
			font-size: 0.875rem;
			font-weight: 600;
			color: var(--sl-color-black);
			text-decoration: none;
			background: linear-gradient(135deg, var(--sl-color-accent) 0%, var(--sl-color-accent-high) 100%);
			border: none;
			transition: transform 0.2s ease, box-shadow 0.2s ease;
		}

		:global(:root[data-theme='light']) .slide-link {
			background: linear-gradient(135deg, var(--sl-color-accent) 0%, var(--sl-color-accent) 50%, var(--sl-color-accent-low) 100%);
			color: #fff;
		}

		.slide-link:hover {
			transform: scale(1.02);
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
		}

		.slide-link-wrapper {
			position: relative;
		}

		/* Mobile: text only, compact */
		.slide-link-mobile {
			padding: 0.25rem 0.5rem;
			font-size: 0.8125rem;
			margin-right: 0;
		}

		/* Desktop: hide mobile, show desktop */
		.slide-link-desktop {
			display: none;
		}

		@media (min-width: 50rem) {
			.slide-link-mobile {
				display: none;
			}
			.slide-link-desktop {
				display: flex;
			}
		}

		@media (min-width: 50rem) {
			:global(:root[data-has-sidebar]) {
				--__sidebar-pad: calc(2 * var(--sl-nav-pad-x));
			}
			:global(:root:not([data-has-toc])) {
				--__toc-width: 0rem;
			}
			.header {
				--__sidebar-width: max(0rem, var(--sl-content-inline-start, 0rem) - var(--sl-nav-pad-x));
				--__main-column-fr: calc(
					(
							100% + var(--__sidebar-pad, 0rem) - var(--__toc-width, var(--sl-sidebar-width)) -
								(2 * var(--__toc-width, var(--sl-nav-pad-x))) - var(--sl-content-inline-start, 0rem) -
								var(--sl-content-width)
						) / 2
				);
				display: grid;
				grid-template-columns:
        /* 1 (site title): runs up until the main content column's left edge or the width of the title, whichever is the largest  */
					minmax(
						calc(var(--__sidebar-width) + max(0rem, var(--__main-column-fr) - var(--sl-nav-gap))),
						auto
					)
					/* 2 (search box): all free space that is available. */
					1fr
					/* 3 (right items): use the space that these need. */
					auto;
				align-content: center;
			}
		}
	}
</style>

<!-- Modal styles outside @layer for proper z-index stacking -->
<style>
	.slide-hint-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		width: 100vw;
		height: 100vh;
		z-index: 99999;
		display: flex;
		align-items: center;
		justify-content: center;
		background: rgba(0, 0, 0, 0.6);
		backdrop-filter: blur(8px);
		-webkit-backdrop-filter: blur(8px);
		opacity: 0;
		visibility: hidden;
		transition: opacity 0.3s ease, visibility 0.3s;
	}

	.slide-hint-overlay.visible {
		opacity: 1;
		visibility: visible;
	}

	.slide-hint-modal {
		position: relative;
		background: var(--sl-color-bg-nav);
		border: 1px solid var(--sl-color-gray-5);
		border-radius: 1rem;
		box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4);
		padding: 1.5rem;
		padding-top: 2.5rem;
		max-width: calc(100vw - 2rem);
		width: 280px;
		transform: scale(0.9);
		transition: transform 0.3s ease;
	}

	.slide-hint-overlay.visible .slide-hint-modal {
		transform: scale(1);
	}

	.slide-hint-content {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	.slide-hint-title {
		font-size: 0.75rem;
		font-weight: 600;
		color: var(--sl-color-gray-3);
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.slide-hint-action {
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
		padding: 0.75rem 1rem;
		background: linear-gradient(135deg, var(--sl-color-accent) 0%, var(--sl-color-accent-high) 100%);
		color: var(--sl-color-black);
		font-weight: 600;
		font-size: 0.9375rem;
		text-decoration: none;
		border-radius: 0.75rem;
		transition: transform 0.2s ease, box-shadow 0.2s ease;
	}

	:root[data-theme='light'] .slide-hint-action {
		background: linear-gradient(135deg, var(--sl-color-accent) 0%, var(--sl-color-accent) 50%, var(--sl-color-accent-low) 100%);
		color: #fff;
	}

	.slide-hint-action:hover {
		transform: scale(1.02);
		box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
	}

	.slide-hint-dismiss {
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 0.75rem 1rem;
		background: var(--sl-color-gray-6);
		color: var(--sl-color-text);
		font-weight: 500;
		font-size: 0.9375rem;
		text-decoration: none;
		border: 1px solid var(--sl-color-gray-5);
		border-radius: 0.75rem;
		cursor: pointer;
		transition: background 0.2s ease, border-color 0.2s ease;
	}

	.slide-hint-dismiss:hover {
		background: var(--sl-color-gray-5);
		border-color: var(--sl-color-gray-4);
	}

	.slide-hint-close {
		position: absolute;
		top: 0.75rem;
		right: 0.75rem;
		display: flex;
		align-items: center;
		justify-content: center;
		width: 1.75rem;
		height: 1.75rem;
		padding: 0;
		background: transparent;
		border: none;
		border-radius: 50%;
		color: var(--sl-color-gray-3);
		cursor: pointer;
		transition: background 0.2s, color 0.2s;
	}

	.slide-hint-close:hover {
		background: var(--sl-color-gray-6);
		color: var(--sl-color-text);
	}
</style>

<script>
	/**
	 * 初回訪問時のSlideヒントモーダル
	 * - localStorageで「次回から表示しない」フラグを管理
	 * - 初回訪問時のみモーダルを表示
	 */
	const STORAGE_KEY = 'slidoc-slide-hint-dismissed';

	function initSlideHintModal() {
		const overlay = document.getElementById('slideHintOverlay');
		if (!overlay) return;

		// 「次回から表示しない」が設定されていたらスキップ
		if (localStorage.getItem(STORAGE_KEY)) return;

		// スライドモードから遷移してきた場合はスキップ（sessionStorageでフラグ管理）
		const FROM_SLIDE_KEY = 'slidoc-from-slide';
		if (sessionStorage.getItem(FROM_SLIDE_KEY)) {
			sessionStorage.removeItem(FROM_SLIDE_KEY);
			return;
		}

		const closeBtn = overlay.querySelector('.slide-hint-close');
		const dismissBtn = document.getElementById('slideHintDismiss');

		// モーダルを閉じる処理
		function closeModal() {
			overlay.classList.remove('visible');
		}

		// 「Don't show again」ボタン - localStorageに保存して閉じる
		function dismissModal() {
			localStorage.setItem(STORAGE_KEY, 'true');
			overlay.classList.remove('visible');
		}

		// 閉じるボタン（×）
		closeBtn?.addEventListener('click', closeModal);

		// 「Don't show again」ボタン
		dismissBtn?.addEventListener('click', dismissModal);

		// オーバーレイクリックで閉じる（モーダル内はスキップ）
		overlay.addEventListener('click', (e) => {
			if (e.target === overlay) {
				closeModal();
			}
		});

		// ESCキーで閉じる
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && overlay.classList.contains('visible')) {
				closeModal();
			}
		});

		// 少し遅延させてからモーダル表示
		setTimeout(() => {
			overlay.classList.add('visible');
		}, 800);
	}

	// ページ読み込み時に実行
	initSlideHintModal();

	// View Transitions対応
	document.addEventListener('astro:page-load', initSlideHintModal);
</script>
